# 房间工作设计案（草案阶段）

# 需求

- 任务分配
- 紧急转换
- 置空时作业
- 根据任务自动增减 creep 数量

# 发现的问题

怎么管理空闲的 creep？

# 房间运维需求

- ✨能量挖掘及能量container维护
- 刷墙
- 建筑维修
- ✨建造
- ✨升级

# 数量增减触发条件

- 工作单位：房间能量产出率提高或减少
- 运输单位：工作时间等于寿命（忙不过来了）则增加，有运输单位的工作时间不到寿命的一半（这个数值待定）就减少

这样就形成如下正向循环：

运输单位增加 > 运力保证 > 挖能量单位体型增大 > 能量产出提高 > 工作单位增加 > spawn 孵化频繁 > 运输压力增加 > 运输单位增加 

# 能量产出率和能量数量

判断是否孵化某个 creep 主要有两种条件：能量产出率和能量数量

# 任务结构

```js
{
    // 任务类型
    type: '',
    // 该任务需要的 creep 类型（重型、均衡性、轻型）
    creepType: '',
    // 该任务需要多少 creep 来做
    creepNum: 3
}
```

任务处理逻辑

```js
{
    [type]: {
        // 任务目标，返回 boolean 标志任务是否完成
        target: () => {},
        // 工作逻辑
        work: () => {},
    }
}
```

# 生命周期

- 孵化完成：询问工作分配模块，领取任务。
- 执行任务：任务完成后访问工作分配模块，该模块会给执行相同任务的 creep 重新分配工作。
- 接到工作分配模块通知：需要优先处理某个任务。
- 空闲时期：
- 去世：回收模块检查内存字段，有指定字段的就会访问工作分配模块，然后让该模块重新分配任务。

# 核心参数

- 孵化力：房间 spawn 的孵化能力
- 运输力：creep 搬运房间内资源的能力
- 生产力：房间内采集能量的能力
- 消耗力：房间内使用能量的能力

# 启动逻辑

孵化一个采集单位，采集能量并运到spawn
---
孵化两个采集单位，无脑采集能量并扔到地上
---
孵化工作单位，捡能量并修建 container
孵化工作单位，升级controller

# 设计

每个 controller 维护如下两个数据集：

**creeps**：对象，当前所有正在执行任务的 creep，非持久，在重置后进行重建

```js
creeps: {
    'creepId': {
        dead: Game.time + 生命时间,
        doing: '当前正在执行的任务索引',
        bodyType: '该 creep 身体类型'
    }
}
```

**tasks**：数组，当前所有任务（按优先级排序），持久到内存

```js
tasks: [
    {
        优先级，
        执行的人中有多少符合需要的身体部件的，
        当前共有多少人执行，
        期望有多少人执行（分配任务时保证绝对不会大于该值），
        任务类型，
        索引，
        需要的身体部件，
    },
    // ...
]
```

## api 设计

- 【私有】把 creep 分配到指定任务（给 creep 设置当前任务，任务里共有多少人 + 1）
- 【私有】把 creep 从指定任务抽离
- 新增任务（添加任务，默认不会重新分配，可以指定选项强制重新分派任务）
- 【私有】给 creep 分配任务
- 重新分配 creep 到任务

## 为什么能量采集任务不并入工作任务队列

- 问题1：**能量采集任务有自主性，而工作任务队列没有**：能量采集任务需要根据环境的变化自主修改自身的状态，例如刚开局时搬运能量到基地，有 container 时无脑采集，有 link 时转移能量。而其他工作任务没有这种需求（升级、建造都是很单纯的逻辑），如果并入工作任务队列的话，就需要借助外部模块进行修改，这样会出现无用逻辑。

    并且工作任务是由其他模块发布的，这就导致本来需要内聚在能量采集单位内部的逻辑（判断当前是什么采集状态，确定后保存至任务）错误的出现在了其他模块中。

- 问题2：**能量采集任务的优先级远高于工作任务**：无论工作任务怎么变更，能量采集任务的优先级都是最高的，如果出现了比能量采集优先级高的任务，就很有可能导致能量采集任务人手不够然后整个基地宕机。如果并入工作任务的话，就需要在发布任务时要考虑能量采集的最高优先级问题，增加了心智负担和额外判断逻辑。

- 问题3：**混淆工作任务的目的**：工作任务应都是“消耗能量”的任务，采集任务的引入破坏了这个纯洁性。举个直观的后果，如果工作任务没有采集任务的话，支援单位只需要无脑执行工作任务即可，而引入了采集任务之后，就需要增加额外的逻辑避免支援单位去采集能量（大体型支援单位去采集能量会很浪费，因为采集出来的能量消化不了）。

**总结**：从终极目标来看，只考虑体型的话，能量采集任务完全可以并入工作任务队列，但是对框架提出了更高级的要求，故现阶段能量采集任务不并入工作任务