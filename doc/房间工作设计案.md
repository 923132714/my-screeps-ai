# 房间工作设计案（草案阶段）

# 需求

- 任务分配
- 紧急转换
- 置空时作业
- 根据任务自动增减 creep 数量

# 发现的问题

怎么管理空闲的 creep？

# 房间运维需求

- ✨能量挖掘及能量container维护
- 刷墙
- 建筑维修
- ✨建造
- ✨升级

# 数量增减触发条件

- 工作单位：房间能量产出率提高或减少
- 运输单位：工作时间等于寿命（忙不过来了）则增加，有运输单位的工作时间不到寿命的一半（这个数值待定）就减少

这样就形成如下正向循环：

运输单位增加 > 运力保证 > 挖能量单位体型增大 > 能量产出提高 > 工作单位增加 > spawn 孵化频繁 > 运输压力增加 > 运输单位增加 

# 能量产出率和能量数量

判断是否孵化某个 creep 主要有两种条件：能量产出率和能量数量

# 任务结构

```js
{
    // 任务类型
    type: '',
    // 该任务需要的 creep 类型（重型、均衡性、轻型）
    creepType: '',
    // 该任务需要多少 creep 来做
    creepNum: 3
}
```

任务处理逻辑

```js
{
    [type]: {
        // 任务目标，返回 boolean 标志任务是否完成
        target: () => {},
        // 工作逻辑
        work: () => {},
    }
}
```

# 生命周期

- 孵化完成：询问工作分配模块，领取任务。
- 执行任务：任务完成后访问工作分配模块，该模块会给执行相同任务的 creep 重新分配工作。
- 接到工作分配模块通知：需要优先处理某个任务。
- 空闲时期：
- 去世：回收模块检查内存字段，有指定字段的就会访问工作分配模块，然后让该模块重新分配任务。

# 核心参数

- 孵化力：房间 spawn 的孵化能力
- 运输力：creep 搬运房间内资源的能力
- 生产力：房间内采集能量的能力
- 消耗力：房间内使用能量的能力

# 启动逻辑

孵化一个采集单位，采集能量并运到spawn
---
孵化两个采集单位，无脑采集能量并扔到地上
---
孵化工作单位，捡能量并修建 container
孵化工作单位，升级controller

# 设计

每个 controller 维护如下两个数据集：

**creeps**：对象，当前所有正在执行任务的 creep，非持久，在重置后进行重建

```js
creeps: {
    'creepId': {
        dead: Game.time + 生命时间,
        doing: '当前正在执行的任务索引',
        bodyType: '该 creep 身体类型'
    }
}
```

**tasks**：数组，当前所有任务（按优先级排序），持久到内存

```js
tasks: [
    {
        优先级，
        执行的人中有多少符合需要的身体部件的，
        当前共有多少人执行，
        期望有多少人执行（分配任务时保证绝对不会大于该值），
        任务类型，
        索引，
        需要的身体部件，
    },
    // ...
]
```

## api 设计

- 【私有】把 creep 分配到指定任务（给 creep 设置当前任务，任务里共有多少人 + 1）
- 【私有】把 creep 从指定任务抽离
- 新增任务（添加任务，默认不会重新分配，可以指定选项强制重新分派任务）
- 【私有】给 creep 分配任务
- 重新分配 creep 到任务